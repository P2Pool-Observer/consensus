//go:build amd64 && !purego

#include "textflag.h"

// func aes_rounds(state *[16]uint64, roundKeys *[aesRounds * 4]uint32) {
TEXT ·aes_rounds_internal(SB),NOSPLIT|NOFRAME,$0-16
    MOVQ state+0(FP), AX
	MOVQ roundKeys+8(FP), BX

	MOVAPD 0*16(BX), X1
	MOVAPD 1*16(BX), X2
	MOVAPD 2*16(BX), X3
	MOVAPD 3*16(BX), X4
	MOVAPD 4*16(BX), X5
	MOVAPD 5*16(BX), X6
	MOVAPD 6*16(BX), X7
	MOVAPD 7*16(BX), X8
	MOVAPD 8*16(BX), X9
	MOVAPD 9*16(BX), X10

	MOVAPD 0(AX), X0
	AESENC X1, X0
	AESENC X2, X0
	AESENC X3, X0
	AESENC X4, X0
	AESENC X5, X0
	AESENC X6, X0
	AESENC X7, X0
	AESENC X8, X0
	AESENC X9, X0
	AESENC X10, X0
	MOVAPD X0, 0(AX)

	MOVAPD 16(AX), X0
	AESENC X1, X0
	AESENC X2, X0
	AESENC X3, X0
	AESENC X4, X0
	AESENC X5, X0
	AESENC X6, X0
	AESENC X7, X0
	AESENC X8, X0
	AESENC X9, X0
	AESENC X10, X0
	MOVAPD X0, 16(AX)

	MOVAPD 32(AX), X0
	AESENC X1, X0
	AESENC X2, X0
	AESENC X3, X0
	AESENC X4, X0
	AESENC X5, X0
	AESENC X6, X0
	AESENC X7, X0
	AESENC X8, X0
	AESENC X9, X0
	AESENC X10, X0
	MOVAPD X0, 32(AX)

	MOVAPD 48(AX), X0
	AESENC X1, X0
	AESENC X2, X0
	AESENC X3, X0
	AESENC X4, X0
	AESENC X5, X0
	AESENC X6, X0
	AESENC X7, X0
	AESENC X8, X0
	AESENC X9, X0
	AESENC X10, X0
	MOVAPD X0, 48(AX)

	MOVAPD 64(AX), X0
	AESENC X1, X0
	AESENC X2, X0
	AESENC X3, X0
	AESENC X4, X0
	AESENC X5, X0
	AESENC X6, X0
	AESENC X7, X0
	AESENC X8, X0
	AESENC X9, X0
	AESENC X10, X0
	MOVAPD X0, 64(AX)

	MOVAPD 80(AX), X0
	AESENC X1, X0
	AESENC X2, X0
	AESENC X3, X0
	AESENC X4, X0
	AESENC X5, X0
	AESENC X6, X0
	AESENC X7, X0
	AESENC X8, X0
	AESENC X9, X0
	AESENC X10, X0
	MOVAPD X0, 80(AX)

	MOVAPD 96(AX), X0
	AESENC X1, X0
	AESENC X2, X0
	AESENC X3, X0
	AESENC X4, X0
	AESENC X5, X0
	AESENC X6, X0
	AESENC X7, X0
	AESENC X8, X0
	AESENC X9, X0
	AESENC X10, X0
	MOVAPD X0, 96(AX)

	MOVAPD 112(AX), X0
	AESENC X1, X0
	AESENC X2, X0
	AESENC X3, X0
	AESENC X4, X0
	AESENC X5, X0
	AESENC X6, X0
	AESENC X7, X0
	AESENC X8, X0
	AESENC X9, X0
	AESENC X10, X0
	MOVAPD X0, 112(AX)

	RET

// func aes_rounds(state *[16]uint64, roundKeys *[aesRounds * 4]uint32) {
TEXT ·aes_rounds_internal_avx512(SB),NOSPLIT|NOFRAME,$0-16
    MOVQ state+0(FP), AX
	MOVQ roundKeys+8(FP), BX

	VBROADCASTI64X2 0*16(BX), Z1
	VBROADCASTI64X2 1*16(BX), Z2
	VBROADCASTI64X2 2*16(BX), Z3
	VBROADCASTI64X2 3*16(BX), Z4
	VBROADCASTI64X2 4*16(BX), Z5
	VBROADCASTI64X2 5*16(BX), Z6
	VBROADCASTI64X2 6*16(BX), Z7
	VBROADCASTI64X2 7*16(BX), Z8
	VBROADCASTI64X2 8*16(BX), Z9
	VBROADCASTI64X2 9*16(BX), Z10

	VMOVUPD 0(AX), Z0
	VAESENC Z1, Z0, Z0
	VAESENC Z2, Z0, Z0
	VAESENC Z3, Z0, Z0
	VAESENC Z4, Z0, Z0
	VAESENC Z5, Z0, Z0
	VAESENC Z6, Z0, Z0
	VAESENC Z7, Z0, Z0
	VAESENC Z8, Z0, Z0
	VAESENC Z9, Z0, Z0
	VAESENC Z10, Z0, Z0
	VMOVUPD Z0, 0(AX)

	VMOVUPD 64(AX), Z0
	VAESENC Z1, Z0, Z0
	VAESENC Z2, Z0, Z0
	VAESENC Z3, Z0, Z0
	VAESENC Z4, Z0, Z0
	VAESENC Z5, Z0, Z0
	VAESENC Z6, Z0, Z0
	VAESENC Z7, Z0, Z0
	VAESENC Z8, Z0, Z0
	VAESENC Z9, Z0, Z0
	VAESENC Z10, Z0, Z0
	VMOVUPD Z0, 64(AX)

	RET

// func aes_single_round(dst, src *[2]uint64, roundKey *[2]uint64)
TEXT ·aes_single_round_internal(SB),NOSPLIT|NOFRAME,$0-24
    MOVQ dst+0(FP), AX
	MOVQ src+8(FP), BX
	MOVQ roundKey+16(FP), CX

	MOVAPD 0(BX), X0
	MOVUPD 0(CX), X1

	AESENC X1, X0

	MOVUPD X0, 0(AX)
	RET
